<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envanter Ekle</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Rent A Car - Envanter Ekle</h1>
    </header>
    <nav>
        <ul class="menu">
            <li><a href="index.html">Ana Sayfa</a></li>
            <li><a href="list-cars.html">Araçlar Listesi</a></li>
            <li><a href="update-car.html">Envanter Güncelle</a></li>
            <li><a href="filter-cars.html">Envanter Filtreleme</a></li>
        </ul>
    </nav>
    <main>
        <h2>Yeni Araç Ekle</h2>
        <form id="addCarForm">
            <label for="model">Model:</label>
            <input type="text" id="model" name="model" required>

            <label for="year">Model Yılı:</label>
            <input type="number" id="year" name="year" min="2000" max="2024" required>

            <label for="km">Kilometre:</label>
            <input type="number" id="km" name="km" required>

            <label for="color">Renk:</label>
            <input type="text" id="color" name="color" required>

            <label for="fuel">Yakıt Türü:</label>
            <select id="fuel" name="fuel" required>
                <option value="Benzin">Benzin</option>
                <option value="Dizel">Dizel</option>
                <option value="Hibrit">Hibrit</option>
                <option value="Elektrik">Elektrik</option>
            </select>

            <label for="transmission">Şanzıman:</label>
            <select id="transmission" name="transmission" required>
                <option value="Otomatik">Otomatik</option>
                <option value="Düz">Düz</option>
            </select>

            <label for="carImage">Araç Fotoğrafı:</label>
            <input type="file" id="carImage" name="carImage" accept="image/*" required>

            <button type="submit">Araç Ekle</button>
        </form>
        <p id="successMessage" style="display:none; color:green;">Araç başarıyla eklendi!</p>
        <p id="errorMessage" style="display:none; color:red;">Bir hata oluştu! Lütfen tekrar deneyin.</p>
    </main>
    <script>
        const addCarForm = document.getElementById('addCarForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        let db;

        // IndexedDB'yi başlatma
        const request = indexedDB.open("CarInventoryDB", 1);

        request.onupgradeneeded = (event) => {
            db = event.target.result;

            // Araçlar için object store oluştur
            if (!db.objectStoreNames.contains("cars")) {
                db.createObjectStore("cars", { keyPath: "id", autoIncrement: true });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log("IndexedDB başarıyla başlatıldı.");
        };

        request.onerror = (event) => {
            console.error("IndexedDB başlatılırken bir hata oluştu:", event.target.error);
        };

        // Araç Ekleme İşlemi
        addCarForm.addEventListener('submit', function (event) {
            event.preventDefault();

            // Eğer IndexedDB başlatılmadıysa uyar
            if (!db) {
                alert("Veritabanı bağlantısı yok! Lütfen tekrar deneyin.");
                return;
            }

            const carImage = document.getElementById('carImage').files[0];

            if (!carImage) {
                alert('Lütfen bir araç fotoğrafı yükleyin');
                return;
            }

            // Fotoğrafı base64 formatına dönüştürme
            const reader = new FileReader();
            reader.onloadend = function () {
                const base64Image = reader.result;

                // Yeni araç bilgilerini al
                const newCar = {
                    model: document.getElementById('model').value.trim(),
                    year: parseInt(document.getElementById('year').value),
                    km: parseInt(document.getElementById('km').value),
                    color: document.getElementById('color').value.trim(),
                    fuel: document.getElementById('fuel').value,
                    transmission: document.getElementById('transmission').value,
                    image: base64Image // Fotoğrafı base64 olarak saklıyoruz
                };

                // IndexedDB'ye ekleme
                const transaction = db.transaction(["cars"], "readwrite");
                const store = transaction.objectStore("cars");

                const request = store.add(newCar);

                request.onsuccess = () => {
                    console.log("Yeni araç başarıyla eklendi:", newCar);

                    // Başarı mesajı ve form sıfırlama
                    successMessage.style.display = 'block';
                    errorMessage.style.display = 'none';
                    addCarForm.reset();

                    // 3 saniye sonra başarı mesajını gizle
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                };

                request.onerror = (event) => {
                    console.error("Araç eklenirken bir hata oluştu:", event.target.error);
                    successMessage.style.display = 'none';
                    errorMessage.style.display = 'block';

                    // 3 saniye sonra hata mesajını gizle
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 3000);
                };
            };

            // Fotoğrafı base64 olarak oku
            reader.readAsDataURL(carImage);
        });
    </script>
</body>

</html>
